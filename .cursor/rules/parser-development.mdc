---
description: ç½‘ç«™è§£æå™¨å¼€å‘å’Œç»´æŠ¤æŒ‡å—
---

# ç½‘ç«™è§£æå™¨å¼€å‘è§„èŒƒ

## è§£æå™¨æ¶æ„

### åŸºç¡€è§£æå™¨ç±»ç»“æ„
å‚è€ƒ[content.js](mdc:chrome-extension/content.js)ä¸­çš„è§£æå™¨å®ç°ï¼š

```javascript
class SiteParser {
  constructor() {
    this.baseURL = 'https://example.com';
    this.extractedURLs = new Set();
  }

  async extractAllPages(extractor = null) {
    // å®ç°ç¿»é¡µæå–é€»è¾‘
  }

  extractCurrentPageURLs() {
    // æå–å½“å‰é¡µé¢çš„URL
  }

  hasNextPage() {
    // æ£€æŸ¥æ˜¯å¦æœ‰ä¸‹ä¸€é¡µ
  }

  async navigateToPage(pageNumber) {
    // å¯¼èˆªåˆ°æŒ‡å®šé¡µé¢
  }
}
```

## æ·»åŠ æ–°ç½‘ç«™æ”¯æŒ

### 1. åˆ›å»ºè§£æå™¨ç±»
```javascript
class NewSiteParser extends SiteParser {
  constructor() {
    super();
    this.baseURL = 'https://newsite.com';
  }

  extractCurrentPageURLs() {
    const urls = [];
    // ä½¿ç”¨ç²¾ç¡®çš„CSSé€‰æ‹©å™¨
    const links = document.querySelectorAll('your-specific-selector');
    
    links.forEach(link => {
      const href = link.getAttribute('href');
      if (href && this.isValidAlbumURL(href)) {
        const fullURL = href.startsWith('http') ? href : this.baseURL + href;
        urls.push(fullURL);
      }
    });
    
    return urls;
  }
}
```

### 2. æ³¨å†Œè§£æå™¨
åœ¨`AlbumURLExtractor`ç±»ä¸­æ·»åŠ ï¼š
```javascript
constructor() {
  this.parsers = {
    'v2ph.com': new V2PHParser(),
    'junmeitu.com': new JunMeituParser(),
    'newsite.com': new NewSiteParser() // æ·»åŠ æ–°è§£æå™¨
  };
}
```

### 3. æ›´æ–°ç½‘ç«™æ£€æµ‹
```javascript
detectSite() {
  const hostname = window.location.hostname;
  
  if (hostname.includes('newsite.com')) {
    this.currentParser = this.parsers['newsite.com'];
    console.log('æ£€æµ‹åˆ°æ–°ç½‘ç«™ï¼Œä½¿ç”¨æ–°è§£æå™¨');
  }
  // å…¶ä»–ç½‘ç«™æ£€æµ‹...
}
```

### 4. æ›´æ–°manifest.json
æ·»åŠ æ–°çš„ä¸»æœºæƒé™ï¼š
```json
"host_permissions": [
  "https://newsite.com/*",
  "https://cdn.newsite.com/*"
]
```

## CSSé€‰æ‹©å™¨ç¼–å†™è§„èŒƒ

### é€‰æ‹©å™¨ä¼˜å…ˆçº§
1. **IDé€‰æ‹©å™¨** - æœ€ç²¾ç¡®ï¼Œä¼˜å…ˆä½¿ç”¨
2. **ç±»é€‰æ‹©å™¨** - æ¬¡ä¼˜å…ˆï¼Œæ³¨æ„ç±»åå˜åŒ–
3. **å±æ€§é€‰æ‹©å™¨** - ç”¨äºç‰¹å®šå±æ€§åŒ¹é…
4. **åä»£é€‰æ‹©å™¨** - é¿å…è¿‡äºå¤æ‚

### é€‰æ‹©å™¨ç¤ºä¾‹
```javascript
// âœ… å¥½çš„é€‰æ‹©å™¨ - å…·ä½“ä¸”ç¨³å®š
'.albums-list .card .card-cover .media-cover'
'div.main > div.list > div.pic-list > ul > li > a'

// âŒ é¿å…çš„é€‰æ‹©å™¨ - è¿‡äºé€šç”¨
'a'
'.link'
'div > a'
```

### å¤‡ç”¨é€‰æ‹©å™¨ç­–ç•¥
```javascript
extractCurrentPageURLs() {
  const selectors = [
    'primary-selector',      // ä¸»è¦é€‰æ‹©å™¨
    'backup-selector-1',     // å¤‡ç”¨é€‰æ‹©å™¨1
    'backup-selector-2'      // å¤‡ç”¨é€‰æ‹©å™¨2
  ];
  
  for (let selector of selectors) {
    const elements = document.querySelectorAll(selector);
    if (elements.length > 0) {
      console.log(`âœ… ä½¿ç”¨é€‰æ‹©å™¨: ${selector}`);
      return this.processElements(elements);
    }
  }
  
  console.warn('âš ï¸ æ‰€æœ‰é€‰æ‹©å™¨éƒ½æœªæ‰¾åˆ°å…ƒç´ ');
  return [];
}
```

## ç¿»é¡µé€»è¾‘å®ç°

### åˆ†é¡µæ£€æµ‹
```javascript
hasNextPage() {
  // æ–¹æ³•1: æŸ¥æ‰¾"ä¸‹ä¸€é¡µ"é“¾æ¥
  const nextLink = document.querySelector('a[href*="next"], a:contains("ä¸‹ä¸€é¡µ")');
  if (nextLink && !nextLink.classList.contains('disabled')) {
    return true;
  }
  
  // æ–¹æ³•2: æ£€æŸ¥é¡µç 
  const currentPage = this.getCurrentPageNumber();
  const lastPage = this.getLastPageNumber();
  return currentPage < lastPage;
}
```

### é¡µé¢å¯¼èˆª
```javascript
async navigateToPage(pageNumber) {
  const newURL = this.buildPageURL(pageNumber);
  
  try {
    const response = await fetch(newURL, {
      headers: {
        'Accept': 'text/html,application/xhtml+xml',
        'Cache-Control': 'no-cache'
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const html = await response.text();
    this.updatePageContent(html);
    window.history.pushState({}, '', newURL);
    
  } catch (error) {
    console.error('å¯¼èˆªå¤±è´¥:', error);
    throw error;
  }
}
```

## æ¼”å‘˜ä¿¡æ¯æå–è§„èŒƒ

### ä¿¡æ¯æå–ç»“æ„
```javascript
async extractActorInfo() {
  const info = {
    name: '',
    image: '',
    info: {},
    description: '',
    url: window.location.href
  };
  
  // æå–å§“å
  info.name = this.extractName();
  
  // æå–å›¾ç‰‡
  info.image = await this.extractImage();
  
  // æå–è¯¦ç»†ä¿¡æ¯
  info.info = this.extractDetailedInfo();
  
  // æå–æè¿°
  info.description = this.extractDescription();
  
  return info;
}
```

### å›¾ç‰‡å¤„ç†
```javascript
async extractImage() {
  const imgSelectors = [
    '.actor-cover img',
    '.profile-image img',
    'img[alt*="æ¼”å‘˜"]'
  ];
  
  for (let selector of imgSelectors) {
    const img = document.querySelector(selector);
    if (img && img.src) {
      try {
        // ä½¿ç”¨ImageProcessorè½¬æ¢å›¾ç‰‡
        const base64 = await window.imageProcessor.convertToBase64(img);
        return base64;
      } catch (error) {
        console.warn('å›¾ç‰‡è½¬æ¢å¤±è´¥:', error);
        return img.src; // è¿”å›åŸå§‹URL
      }
    }
  }
  
  return '';
}
```

## é”™è¯¯å¤„ç†å’Œè°ƒè¯•

### é”™è¯¯å¤„ç†ç­–ç•¥
```javascript
async extractAllPages(extractor = null) {
  try {
    // æå–é€»è¾‘
  } catch (error) {
    console.error('âŒ æå–å¤±è´¥:', error);
    
    // å‘é€é”™è¯¯æ¶ˆæ¯
    chrome.runtime.sendMessage({
      type: 'EXTRACTION_ERROR',
      error: error.message,
      site: window.location.hostname
    });
    
    throw error;
  }
}
```

### è°ƒè¯•ä¿¡æ¯
```javascript
extractCurrentPageURLs() {
  const urls = [];
  const elements = document.querySelectorAll('selector');
  
  console.log(`ğŸ“Š æ‰¾åˆ° ${elements.length} ä¸ªå…ƒç´ `);
  
  elements.forEach((element, index) => {
    const href = element.getAttribute('href');
    console.log(`ğŸ”— å…ƒç´ ${index + 1}: ${href}`);
    
    if (this.isValidURL(href)) {
      urls.push(href);
    }
  });
  
  console.log(`âœ… æœ‰æ•ˆURLæ•°é‡: ${urls.length}`);
  return urls;
}
```

## æ€§èƒ½ä¼˜åŒ–

### æ‰¹é‡å¤„ç†
```javascript
// æ‰¹é‡æ›´æ–°DOMè€Œä¸æ˜¯é€ä¸ªæ“ä½œ
const fragment = document.createDocumentFragment();
urls.forEach(url => {
  const element = this.createURLElement(url);
  fragment.appendChild(element);
});
container.appendChild(fragment);
```

### å†…å­˜ç®¡ç†
```javascript
// åŠæ—¶æ¸…ç†å¤§å¯¹è±¡
this.extractedURLs.clear();

// é¿å…å†…å­˜æ³„æ¼
clearTimeout(this.timeoutId);
removeEventListener('scroll', this.scrollHandler);
```

## æµ‹è¯•å’ŒéªŒè¯

### é€‰æ‹©å™¨æµ‹è¯•
```javascript
// åœ¨æ§åˆ¶å°ä¸­æµ‹è¯•é€‰æ‹©å™¨
document.querySelectorAll('your-selector').length
```

### æ•°æ®éªŒè¯
```javascript
validateExtractedData(data) {
  if (!data.name || data.name.trim() === '') {
    throw new Error('æ¼”å‘˜å§“åä¸èƒ½ä¸ºç©º');
  }
  
  if (!data.info || Object.keys(data.info).length === 0) {
    console.warn('âš ï¸ æœªæå–åˆ°è¯¦ç»†ä¿¡æ¯');
  }
  
  return true;
}
```